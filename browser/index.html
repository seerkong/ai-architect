<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/svg+xml" href="/vite.svg" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI ARCHITECT</title>

  <!-- Vue 3 CDN -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <!-- Object Visualizer CDN -->
  <script src="https://unpkg.com/object-visualizer"></script>
  <link rel="stylesheet" href="https://unpkg.com/object-visualizer/dist/index.min.css">

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      height: 100vh;
      display: flex;
      overflow: hidden;
    }

    /* å·¦ä¾§é¢æ¿ - æŠ€æœ¯æ–‡æ¡£åŠŸèƒ½ */
    .left-panel {
      flex: 2;
      padding: 8px;
      border-right: 2px solid #ddd;
      overflow: hidden;
      background: #f8f9fa;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .left-panel h2 {
      margin: 0 0 8px 0;
      color: #333;
      border-bottom: 2px solid #007bff;
      padding-bottom: 6px;
      flex-shrink: 0;
    }

    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 15px;
      flex-shrink: 0;
    }

    .button-group button {
      padding: 6px 12px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
      transition: background-color 0.2s;
    }

    .button-group button:hover {
      background: #0056b3;
    }

    .button-group button:active {
      background: #004085;
    }

    #data-input {
      width: 100%;
      height: 120px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: monospace;
      font-size: 12px;
      resize: vertical;
      margin-bottom: 20px;
      flex-shrink: 0;
    }

    /* TabåŒºåŸŸæ ·å¼ */
    .tab-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      overflow: hidden;
      height: 0;
      /* å¼ºåˆ¶flexå­å…ƒç´ è®¡ç®—é«˜åº¦ */
    }

    .tab-header {
      display: flex;
      background-color: #f8f9fa;
      border-bottom: 1px solid #ddd;
      flex-shrink: 0;
    }

    .tab-button {
      flex: 1;
      padding: 10px 15px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }

    .tab-button:hover {
      background-color: #e9ecef;
      color: #333;
    }

    .tab-button.active {
      color: #007bff;
      border-bottom-color: #007bff;
      background-color: #fff;
    }

    .tab-content {
      flex: 1;
      display: none;
      overflow: hidden;
      min-height: 0;
    }

    .tab-content.active {
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    #preview-iframe {
      width: 100%;
      height: 100%;
      border: none;
      flex: 1;
      min-height: 0;
    }

    #html-editor {
      width: 100%;
      height: 100%;
      flex: 1;
      min-height: 0;
    }

    #rich-text-editor {
      width: 100%;
      height: 100%;
      flex: 1;
      min-height: 0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Tiptap ç¼–è¾‘å™¨å…¨å±€æ ·å¼ */
    #rich-text-editor .ProseMirror {
      background: #fff;
    }

    /* å³ä¾§é¢æ¿ - AIèŠå¤©åŠŸèƒ½ */
    .right-panel {
      flex: 1;
      padding: 8px;
      background: #fff;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .right-panel h2 {
      margin: 0 0 8px 0;
      color: #333;
      border-bottom: 2px solid #28a745;
      padding-bottom: 6px;
    }

    /* é¡¹ç›®æ“ä½œåŒºåŸŸæ ·å¼ */
    .project-actions-section {
      margin-bottom: 5px;
      padding: 5px;
      background: #f8f9fa;
      border-radius: 6px;
      border: 1px solid #e9ecef;
    }

    /* äº§å“éœ€æ±‚è¾“å…¥åŒºåŸŸæ ·å¼ */
    .prd-input-section {
      margin-bottom: 2px;
    }

    .prd-input-group {
      display: flex;
      gap: 5px;
      margin-bottom: 2px;
    }

    /* PRDé“¾æ¥åŒºåŸŸæ ·å¼ */
    .prd-link-labels {
      display: flex;
      gap: 5px;
      margin-bottom: 5px;
    }

    .prd-link-inputs {
      display: flex;
      gap: 5px;
    }

    .prd-link-label {
      flex: 1;
      font-weight: 500;
      color: #333;
      text-align: center;
      padding: 2px;
    }

    .prd-input {
      flex: 1;
      padding: 2px 2px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: Arial, sans-serif;
      font-size: 12px;
      background: #f9f9f9;
    }

    .prd-input:focus {
      outline: none;
      border-color: #28a745;
      background: #fff;
    }

    .prd-textarea-group {
      display: flex;
      gap: 15px;
      margin-bottom: 5px;
    }

    .prd-textarea {
      flex: 1;
      height: 80px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: Arial, sans-serif;
      font-size: 14px;
      resize: vertical;
      background: #f9f9f9;
    }

    .prd-textarea:focus {
      outline: none;
      border-color: #28a745;
      background: #fff;
    }

    .project-button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 12px;
    }

    .project-btn {
      padding: 2px 2px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 2px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.2s;
      white-space: nowrap;
    }

    .project-btn:hover {
      background: #5a6268;
      transform: translateY(-1px);
    }

    .project-btn:active {
      transform: translateY(0);
      background: #495057;
    }

    .project-input-group {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .input-pair {
      display: flex;
      align-items: center;
      gap: 6px;
      flex: 1;
      min-width: 180px;
    }

    .input-pair label {
      font-size: 12px;
      font-weight: 500;
      color: #495057;
      white-space: nowrap;
      min-width: 50px;
    }

    .project-input {
      flex: 1;
      padding: 5px 8px;
      border: 1px solid #ced4da;
      border-radius: 3px;
      font-size: 12px;
      background: #fff;
      transition: border-color 0.2s;
    }

    .project-input:focus {
      outline: none;
      border-color: #28a745;
      box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.25);
    }

    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .chat-input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    #chat-input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    .chat-buttons {
      display: flex;
      gap: 6px;
    }

    .chat-buttons button {
      padding: 6px 12px;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
      transition: background-color 0.2s;
    }

    #startChatBtn {
      background: #28a745;
      color: white;
    }

    #startChatBtn:hover:not(:disabled) {
      background: #218838;
    }

    #stopChatBtn {
      background: #dc3545;
      color: white;
    }

    #stopChatBtn:hover:not(:disabled) {
      background: #c82333;
    }

    .chat-buttons button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    #chat-output {
      flex: 1;
      background: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      border: 1px solid #ddd;
      white-space: pre-wrap;
      overflow-y: auto;
      scroll-behavior: smooth;
      min-height: 300px;
      font-size: 14px;
      line-height: 1.5;
    }

    .chat-output-placeholder {
      color: #666;
      font-style: italic;
    }

    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }

      .left-panel,
      .right-panel {
        flex: none;
        height: 50vh;
      }

      .left-panel {
        flex: 2;
        border-right: none;
        border-bottom: 2px solid #ddd;
      }

      .right-panel {
        flex: 1;
      }

      .prd-input-group {
        flex-direction: column;
        gap: 2px;
      }

      .prd-textarea-group {
        flex-direction: column;
        gap: 2px;
      }

      .prd-textarea {
        height: 40px;
      }

      .project-button-group {
        flex-direction: column;
        gap: 4px;
      }

      .project-btn {
        width: 100%;
        text-align: center;
        padding: 5px 10px;
      }

      .project-input-group {
        flex-direction: column;
        gap: 8px;
      }

      .input-pair {
        min-width: auto;
      }
    }

    /* JSONå¯è§†åŒ–Tabæ ·å¼ */
    .json-tab-button {
      flex: 1;
      padding: 8px 12px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: 500;
      color: #666;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }

    .json-tab-button:hover {
      background-color: #e9ecef;
      color: #333;
    }

    .json-tab-button.active {
      color: #007bff;
      border-bottom-color: #007bff;
      background-color: #fff;
    }

    .json-tab-content {
      display: none;
      height: 100%;
      overflow: auto;
    }

    .json-tab-content.active {
      display: block;
    }

    /* è¡¨æ ¼æŒ‰é’®æ ·å¼ */
    .table-btn {
      padding: 6px 12px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
      transition: background-color 0.2s;
      margin-right: 6px;
    }

    .table-btn:hover {
      background: #5a6268;
    }

    .table-btn:active {
      background: #495057;
    }

    .table-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    /* Tiptapç¼–è¾‘å™¨æ ·å¼ */
    .ProseMirror {
      outline: none;
      padding: 10px;
      min-height: 200px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #fff;
    }

    .ProseMirror p {
      margin: 0.5em 0;
    }

    .ProseMirror table {
      border-collapse: collapse;
      table-layout: fixed;
      width: 100%;
      overflow: hidden;
      margin: 0;
    }

    .ProseMirror table td,
    .ProseMirror table th {
      min-width: 1em;
      border: 1px solid #ddd;
      padding: 3px 5px;
      vertical-align: top;
      box-sizing: border-box;
      position: relative;
    }

    .ProseMirror table td>*,
    .ProseMirror table th>* {
      margin-bottom: 0;
    }

    .ProseMirror table th {
      font-weight: bold;
      text-align: left;
      background-color: #f1f3f4;
    }

    .ProseMirror table .selectedCell:after {
      z-index: 2;
      position: absolute;
      content: "";
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      background: rgba(200, 200, 255, 0.4);
      pointer-events: none;
    }

    .ProseMirror table .column-resize-handle {
      position: absolute;
      right: -2px;
      top: 0;
      bottom: -2px;
      width: 4px;
      background-color: #adf;
      pointer-events: none;
    }

    .ProseMirror table p {
      margin: 0;
    }
  </style>
</head>

<body>
  <!-- å·¦ä¾§é¢æ¿ - æŠ€æœ¯æ–‡æ¡£åŠŸèƒ½ -->
  <div class="left-panel">
    <h2>ğŸ“ æŠ€æœ¯æ–‡æ¡£å·¥ä½œåŒº</h2>
    <div class="button-group">
      <button id="download-tech-doc-html">å¯¼å‡ºä¸ºhtml</button>
    </div>

    <!-- JSONå¯è§†åŒ–åŒºåŸŸ -->
    <div id="json-visualizer-container"
      style="height: 120px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 20px; overflow: auto; background: #fff;">

      <!-- JSONå¯è§†åŒ–Tabå¤´éƒ¨ -->
      <div class="json-tab-header" style="display: flex; background-color: #f8f9fa; border-bottom: 1px solid #ddd;">
        <button class="json-tab-button active" data-json-tab="dsl">æŠ€æœ¯æ–‡æ¡£DSL</button>
        <button class="json-tab-button" data-json-tab="conversation">å½“å‰å¯¹è¯å˜æ›´</button>
        <button class="json-tab-button" data-json-tab="answer">å½“å‰å›ç­”å˜æ›´</button>
      </div>

      <!-- JSONå¯è§†åŒ–Tabå†…å®¹ -->
      <div class="json-tab-content-container" style="height: calc(100% - 40px); overflow: hidden;">
        <div class="json-tab-content active" id="dsl-tab">
          <div id="json-visualizer-app"></div>
        </div>
        <div class="json-tab-content" id="conversation-tab">
          <div id="conversation-mutation-visualizer"></div>
        </div>
        <div class="json-tab-content" id="answer-tab">
          <div id="answer-mutation-visualizer"></div>
        </div>
      </div>
    </div>

    <!-- PRDæ–‡æ¡£é“¾æ¥è¾“å…¥åŒºåŸŸ -->
    <div class="prd-link-section" style="margin-bottom: 15px;">
      <div class="prd-link-labels">
        <span class="prd-link-label">PRDæ–‡æ¡£link</span>
        <span class="prd-link-label">æŠ€æœ¯é€‰å‹çº¦æŸæ–‡æ¡£link</span>
        <span class="prd-link-label">ç”ŸæˆæŠ€æœ¯æ–‡æ¡£docé“¾æ¥</span>
      </div>
      <div class="prd-link-inputs">
        <input type="text" id="prd-link" class="prd-input" placeholder="PRDæ–‡æ¡£link" value="">
        <input type="text" id="tech-constraints-link" class="prd-input" placeholder="æŠ€æœ¯é€‰å‹çº¦æŸæ–‡æ¡£link" value="">
        <input type="text" id="tech-design-doc-link" class="prd-input" placeholder="ç”ŸæˆæŠ€æœ¯æ–‡æ¡£docé“¾æ¥" value="">
      </div>
    </div>

    <!-- TabåŒºåŸŸ -->
    <div class="tab-container">
      <div class="tab-header">
        <button class="tab-button active" data-tab="rich-text-editor">å¯Œæ–‡æœ¬ç¼–è¾‘å™¨</button>
        <button class="tab-button" data-tab="html-editor">HTMLç¼–è¾‘å™¨</button>

        <button class="tab-button" data-tab="tech-constraints">æŠ€æœ¯çº¦æŸæ–‡æ¡£</button>
        <button class="tab-button" data-tab="source-prd">PRD-åŸå§‹</button>
        <button class="tab-button" data-tab="parsed-prd">PRD-è½¬æ¢å</button>
      </div>

      <div class="tab-content active" id="rich-text-editor-tab">
        <div id="rich-text-editor"></div>
      </div>

      <div class="tab-content" id="html-editor-tab">
        <div id="html-editor"></div>
      </div>

      <div class="tab-content" id="tech-constraints-tab">
        <div id="tech-constraints-editor"></div>
      </div>

      <div class="tab-content" id="source-prd-tab">
        <div id="source-prd-editor"></div>
      </div>

      <div class="tab-content" id="parsed-prd-tab">
        <div id="parsed-prd-editor"></div>
      </div>
    </div>
  </div>

  <!-- å³ä¾§é¢æ¿ - AIèŠå¤©åŠŸèƒ½ -->
  <div class="right-panel">
    <h2>ğŸ¤– AI WEBè½¯ä»¶æ¶æ„å¸ˆ</h2>

    <!-- é¡¹ç›®æ“ä½œåŒºåŸŸ -->
    <div class="project-actions-section">
      <div class="project-input-group">
        <div class="input-pair">
          <label for="project-key">é¡¹ç›®key:</label>
          <input type="text" id="project-key" class="project-input" placeholder="è¯·è¾“å…¥é¡¹ç›®key">
          <button id="update-websocket" class="project-btn" style="margin-left: 8px; padding: 5px 10px;">æ›´æ–°</button>
        </div>
      </div>

      <div class="project-dropdown-group" style="display: flex; gap: 10px; margin-bottom: 12px;">
        <!-- æ¨¡å¼åˆ‡æ¢ä¸‹æ‹‰é€‰æ¡† -->
        <div class="dropdown-container" style="flex: 1;">
          <label for="mode-switch"
            style="display: block; font-size: 12px; font-weight: 500; color: #495057; margin-bottom: 4px;">æ¨¡å¼åˆ‡æ¢:</label>
          <select id="mode-switch" class="project-dropdown"
            style="width: 100%; padding: 6px 8px; border: 1px solid #ced4da; border-radius: 3px; font-size: 12px; background: #fff;">
            <option value="">è¯·é€‰æ‹©æ¨¡å¼</option>
            <option value="reset-input-and-init-modules">1 å¯¼å…¥éœ€æ±‚æ–‡æ¡£å¹¶åˆå§‹åŒ–æ¨¡å—</option>
            <option value="module-design">2 æŠ€æœ¯è®¾è®¡</option>
          </select>
        </div>

        <!-- æ“ä½œæŒ‰é’®ç»„ -->
        <div class="action-buttons-container" style="flex: 1;">
          <label
            style="display: block; font-size: 12px; font-weight: 500; color: #495057; margin-bottom: 4px;">æ“ä½œ:</label>
          <div class="action-buttons" style="display: flex; gap: 8px;">
            <button id="update-detail-btn" class="action-btn"
              style="flex: 1; padding: 6px 12px; border: 1px solid #007bff; border-radius: 3px; font-size: 12px; background: #007bff; color: white; cursor: pointer;">
              æ‹‰å–è¯¦æƒ…
            </button>
            <button id="accept-changes-btn" class="action-btn"
              style="flex: 1; padding: 6px 12px; border: 1px solid #28a745; border-radius: 3px; font-size: 12px; background: #28a745; color: white; cursor: pointer;">
              æ¥å—å˜æ›´
            </button>

          </div>
        </div>
      </div>
    </div>


    <div class="chat-container">
      <!-- ä¼šè¯IDè¾“å…¥åŒºåŸŸ -->
      <div class="conversation-id-section" style="margin-bottom: 10px;">
        <input type="text" id="conversation-id" class="conversation-input" placeholder="ä¼šè¯ID"
          style="width: 100%; padding: 4px 8px; border: 1px solid #ddd; border-radius: 3px; font-size: 11px; background: #f9f9f9;">
      </div>

      <div class="chat-input-group">
        <input type="text" id="chat-input" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." value="">
        <div class="chat-buttons">
          <button id="startChatBtn">å¼€å§‹</button>
          <button id="stopChatBtn" disabled>åœæ­¢</button>
        </div>
      </div>

      <div id="chat-output" class="chat-output-placeholder">ç­‰å¾…è¾“å…¥...</div>
    </div>
  </div>

  <script type="module" src="./src/main.ts"></script>

  <!-- Tiptap å¯Œæ–‡æœ¬ç¼–è¾‘å™¨åˆå§‹åŒ– -->
  <script>
    // å…ˆè®¾ç½®å ä½ç¬¦ï¼Œé˜²æ­¢åœ¨ç¼–è¾‘å™¨åˆå§‹åŒ–å‰è®¿é—®æŠ¥é”™
    window.richTextEditor = {
      setContent: (htmlContent) => {
        console.warn('å¯Œæ–‡æœ¬ç¼–è¾‘å™¨æ­£åœ¨åˆå§‹åŒ–ä¸­...');
      },
      getContent: () => {
        console.warn('å¯Œæ–‡æœ¬ç¼–è¾‘å™¨æ­£åœ¨åˆå§‹åŒ–ä¸­...');
        return '';
      }
    };
  </script>
  <script type="module">
    import { createApp, nextTick, h } from 'vue';
    import { TiptapEditorCapsule } from './packages/tiptap-capsule/src/index.ts';
    
    // ç­‰å¾… DOM åŠ è½½å®Œæˆ
    window.addEventListener('DOMContentLoaded', async () => {
      // ä½¿ç”¨ ESM å¯¼å…¥çš„ Vueï¼Œç¡®ä¿ä¸ TiptapEditorCapsule ä½¿ç”¨åŒä¸€ä¸ª Vue å®ä¾‹
      console.log('å¼€å§‹åˆå§‹åŒ– Tiptap ç¼–è¾‘å™¨...');
      
      // åˆ›å»º Tiptap ç¼–è¾‘å™¨ Vue åº”ç”¨
      const richTextApp = createApp({
        data() {
          return {
            htmlContent: '',
            editorRef: null
          }
        },
        mounted() {
          // ç¼–è¾‘å™¨æŒ‚è½½åçš„åˆå§‹åŒ–é€»è¾‘
          console.log('Tiptap ç¼–è¾‘å™¨å·²æŒ‚è½½');
          console.log('ç¼–è¾‘å™¨ ref:', this.$refs.tiptapEditor);
          // ç­‰å¾…ä¸‹ä¸€ä¸ª tick åå†æ£€æŸ¥
          this.$nextTick(() => {
            if (this.$refs.tiptapEditor && this.$refs.tiptapEditor.editor) {
              console.log('Tiptap editor å®ä¾‹å·²å°±ç»ª');
            } else {
              console.warn('Tiptap editor å®ä¾‹æœªå°±ç»ª');
            }
            
            // è°ƒè¯•ï¼šè¾“å‡ºå®¹å™¨å°ºå¯¸ä¿¡æ¯
            const container = document.getElementById('rich-text-editor');
            if (container) {
              console.log('rich-text-editor å®¹å™¨å°ºå¯¸:', {
                width: container.offsetWidth,
                height: container.offsetHeight,
                display: window.getComputedStyle(container).display,
                flexDirection: window.getComputedStyle(container).flexDirection
              });
            }
            
            const editorEl = container?.querySelector('.tiptap-editor-capsule');
            if (editorEl) {
              console.log('tiptap-editor-capsule å°ºå¯¸:', {
                width: editorEl.offsetWidth,
                height: editorEl.offsetHeight
              });
            }
            
            const proseMirrorEl = container?.querySelector('.ProseMirror');
            if (proseMirrorEl) {
              console.log('ProseMirror å°ºå¯¸:', {
                width: proseMirrorEl.offsetWidth,
                height: proseMirrorEl.offsetHeight
              });
            } else {
              console.warn('ProseMirror å…ƒç´ æœªæ‰¾åˆ°');
            }
            
            // æ£€æŸ¥ heightMode class
            const capsule = container?.querySelector('.tiptap-editor-capsule');
            if (capsule) {
              console.log('ç¼–è¾‘å™¨ class:', capsule.className);
              console.log('æ˜¯å¦åŒ…å« height-mode-fixed:', capsule.classList.contains('height-mode-fixed'));
            }
            
            // æ£€æŸ¥ editor-wrapper çš„æ»šåŠ¨è®¾ç½®
            const editorWrapper = container?.querySelector('.editor-wrapper');
            if (editorWrapper) {
              const styles = window.getComputedStyle(editorWrapper);
              console.log('editor-wrapper æ ·å¼:', {
                flex: styles.flex,
                overflowY: styles.overflowY,
                minHeight: styles.minHeight,
                height: styles.height,
                offsetHeight: editorWrapper.offsetHeight
              });
            }
            
            // æ£€æŸ¥ editor-content çš„è®¾ç½®
            const editorContent = container?.querySelector('.editor-content');
            if (editorContent) {
              const styles = window.getComputedStyle(editorContent);
              console.log('editor-content æ ·å¼:', {
                height: styles.height,
                offsetHeight: editorContent.offsetHeight
              });
            }
          });
        },
        methods: {
          async setContent(htmlContent) {
            console.log('setContent è¢«è°ƒç”¨ï¼Œå†…å®¹é•¿åº¦:', htmlContent.length);
            this.htmlContent = htmlContent;
            
            // ç­‰å¾…ç¼–è¾‘å™¨ ref å°±ç»ªï¼ˆæœ€å¤šç­‰å¾… 2 ç§’ï¼‰
            let attempts = 0;
            const maxAttempts = 20;
            while (!this.$refs.tiptapEditor && attempts < maxAttempts) {
              await new Promise(resolve => setTimeout(resolve, 100));
              attempts++;
            }
            
            if (this.$refs.tiptapEditor) {
              console.log('è°ƒç”¨ setHTMLï¼Œå†…å®¹é¢„è§ˆ:', htmlContent.substring(0, 100));
              this.$refs.tiptapEditor.setHTML(htmlContent);
              console.log('å¯Œæ–‡æœ¬ç¼–è¾‘å™¨å†…å®¹å·²è®¾ç½®');
              // éªŒè¯å†…å®¹æ˜¯å¦çœŸçš„è¢«è®¾ç½®
              await this.$nextTick();
              const currentContent = this.$refs.tiptapEditor.getHTML();
              console.log('å½“å‰ç¼–è¾‘å™¨å†…å®¹é•¿åº¦:', currentContent.length);
            } else {
              console.warn('TiptapEditor ref åœ¨ 2 ç§’å†…æœªå°±ç»ª');
            }
          },
          getContent() {
            if (this.$refs.tiptapEditor) {
              return this.$refs.tiptapEditor.getHTML();
            }
            return '';
          }
        },
        // ä½¿ç”¨ render å‡½æ•°æ›¿ä»£ template å­—ç¬¦ä¸²
        render() {
          return h('div', {
            style: 'width: 100%; height: 100%; display: flex; flex-direction: column;'
          }, [
            h(TiptapEditorCapsule, {
              ref: 'tiptapEditor',
              modelValue: this.htmlContent,
              'onUpdate:modelValue': (value) => {
                this.htmlContent = value;
              },
              enableVueTextBtnDemo: false,
              enableBubbleMenu: true,
              editable: true,
              showToolbar: true,
              showOutput: false,
              heightMode: 'fixed',  // å›ºå®šé«˜åº¦æ¨¡å¼ï¼Œç¼–è¾‘åŒºåŸŸå¯æ»šåŠ¨
              style: 'flex: 1; overflow: hidden;'
            })
          ]);
        }
      });

      // æŒ‚è½½ Tiptap ç¼–è¾‘å™¨
      const richTextVm = richTextApp.mount('#rich-text-editor');

      // ç­‰å¾…ç»„ä»¶å®Œå…¨æŒ‚è½½å’Œæ¸²æŸ“
      await nextTick();
      await new Promise(resolve => setTimeout(resolve, 500));

      // æš´éœ²åˆ°å…¨å±€ï¼Œä»¥ä¾¿å…¶ä»–ä»£ç å¯ä»¥è°ƒç”¨
      window.richTextEditor = {
        setContent: (htmlContent) => {
          richTextVm.setContent(htmlContent);
        },
        getContent: () => {
          return richTextVm.getContent();
        }
      };

      console.log('Tiptap å¯Œæ–‡æœ¬ç¼–è¾‘å™¨åˆå§‹åŒ–å®Œæˆ');
      console.log('window.richTextEditor å·²æš´éœ²åˆ°å…¨å±€');
    });
  </script>

  <!-- Vue JSON Visualizer App -->
  <script>
    // ç­‰å¾…Vueå’ŒObjectVisualizeråŠ è½½å®Œæˆ
    document.addEventListener('DOMContentLoaded', function() {
      // ä½¿ç”¨è½®è¯¢æ–¹å¼æ£€æŸ¥ObjectVisualizeræ˜¯å¦å®Œå…¨åŠ è½½
      function waitForObjectVisualizer() {
        if (typeof Vue !== 'undefined' &&
          typeof ObjectVisualizer !== 'undefined' &&
          ObjectVisualizer.ObjectVisualizer) {
          initializeVueApp();
        } else {
          // å¦‚æœè¿˜æ²¡åŠ è½½å®Œæˆï¼Œç»§ç»­ç­‰å¾…
          setTimeout(waitForObjectVisualizer, 100);
        }
      }

      function initializeVueApp() {
        const { createApp } = Vue;

        // Tiptapåº“æ£€æŸ¥å·²ç¦ç”¨ï¼Œç›´æ¥åˆå§‹åŒ–Vueåº”ç”¨
        console.log('åˆå§‹åŒ–Vueåº”ç”¨...');

        // åˆ›å»ºVueåº”ç”¨
        const app = createApp({
          data() {
            return {
              dslData: null,
              conversationMutation: null,
              answerMutation: null,
              isLoading: true
            }
          },
          components: {
            // åŠ¨æ€æ³¨å†ŒObjectVisualizerç»„ä»¶
            ObjectVisualizer: ObjectVisualizer.ObjectVisualizer
          },
          mounted() {
            // åˆå§‹åŒ–æ—¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            this.loadDslData();
          },
          methods: {
            loadDslData() {
              // è¿™é‡Œå°†ä»TechDocAIAgentActorApiè·å–æ•°æ®
              // æš‚æ—¶æ˜¾ç¤ºç©ºæ•°æ®
              this.dslData = {};
              this.conversationMutation = null;
              this.answerMutation = null;
              this.isLoading = false;
            },
            updateDslData(newData) {
              this.dslData = newData;
              this.isLoading = false;
            },
            updateConversationMutation(newData) {
              this.conversationMutation = newData;
            },
            updateAnswerMutation(newData) {
              this.answerMutation = newData;
            }
          },
          template: `
            <div style="height: 100%; padding: 10px; overflow: auto;">
              <div v-if="isLoading" style="text-align: center; padding: 20px; color: #666;">
                åŠ è½½ä¸­...
              </div>
              <div v-else-if="dslData && Object.keys(dslData).length > 0">
                <ObjectVisualizer 
                  :data="dslData" 
                  rootName="æŠ€æœ¯æ–‡æ¡£DSL"
                  :expandOnCreatedAndUpdated="(path) => path.length <= 2"
                />
              </div>
              <div v-else style="text-align: center; padding: 20px; color: #999;">
                æš‚æ— æ•°æ®ï¼Œè¯·å…ˆæ‹‰å–é¡¹ç›®è¯¦æƒ…
              </div>
            </div>
          `
        });

        // åˆ›å»ºå¯¹è¯å˜æ›´å¯è§†åŒ–åº”ç”¨
        const conversationApp = createApp({
          data() {
            return {
              conversationMutation: null,
              isLoading: false
            }
          },
          components: {
            ObjectVisualizer: ObjectVisualizer.ObjectVisualizer
          },
          methods: {
            updateData(newData) {
              this.conversationMutation = newData;
            }
          },
          template: `
            <div style="height: 100%; padding: 10px; overflow: auto;">
              <div v-if="conversationMutation && Object.keys(conversationMutation).length > 0">
                <ObjectVisualizer 
                  :data="conversationMutation" 
                  rootName="å¯¹è¯å˜æ›´"
                  :expandOnCreatedAndUpdated="(path) => path.length <= 2"
                />
              </div>
              <div v-else style="text-align: center; padding: 20px; color: #999;">
                æš‚æ— å¯¹è¯å˜æ›´æ•°æ®
              </div>
            </div>
          `
        });

        // åˆ›å»ºå›ç­”å˜æ›´å¯è§†åŒ–åº”ç”¨
        const answerApp = createApp({
          data() {
            return {
              answerMutation: null,
              isLoading: false
            }
          },
          components: {
            ObjectVisualizer: ObjectVisualizer.ObjectVisualizer
          },
          methods: {
            updateData(newData) {
              this.answerMutation = newData;
            }
          },
          template: `
            <div style="height: 100%; padding: 10px; overflow: auto;">
              <div v-if="answerMutation && Object.keys(answerMutation).length > 0">
                <ObjectVisualizer 
                  :data="answerMutation" 
                  rootName="å›ç­”å˜æ›´"
                  :expandOnCreatedAndUpdated="(path) => path.length <= 2"
                />
              </div>
              <div v-else style="text-align: center; padding: 20px; color: #999;">
                æš‚æ— å›ç­”å˜æ›´æ•°æ®
              </div>
            </div>
          `
        });

        // æŒ‚è½½Vueåº”ç”¨
        const vm = app.mount('#json-visualizer-app');
        const conversationVm = conversationApp.mount('#conversation-mutation-visualizer');
        const answerVm = answerApp.mount('#answer-mutation-visualizer');

        // å°†Vueåº”ç”¨å®ä¾‹å’Œç»„ä»¶å®ä¾‹æš´éœ²åˆ°å…¨å±€ï¼Œä»¥ä¾¿å…¶ä»–ä»£ç å¯ä»¥è°ƒç”¨
        window.jsonVisualizerApp = {
          app: app,
          updateDslData: (newData) => {
            vm.updateDslData(newData);
          },
          updateConversationMutation: (newData) => {
            conversationVm.updateData(newData);
          },
          updateAnswerMutation: (newData) => {
            answerVm.updateData(newData);
          }
        };

        // æ·»åŠ JSON tabåˆ‡æ¢åŠŸèƒ½
        function initJsonTabSwitching() {
          const tabButtons = document.querySelectorAll('.json-tab-button');
          const tabContents = document.querySelectorAll('.json-tab-content');

          tabButtons.forEach(button => {
            button.addEventListener('click', () => {
              const tabName = button.getAttribute('data-json-tab');

              // ç§»é™¤æ‰€æœ‰activeç±»
              tabButtons.forEach(btn => btn.classList.remove('active'));
              tabContents.forEach(content => content.classList.remove('active'));

              // æ·»åŠ activeç±»åˆ°å½“å‰tab
              button.classList.add('active');
              document.getElementById(tabName + '-tab').classList.add('active');
            });
          });
        }

        // åˆå§‹åŒ–tabåˆ‡æ¢
        initJsonTabSwitching();

        // åˆå§‹åŒ–å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
        initializeRichTextEditor();
      }

      // å¯Œæ–‡æœ¬ç¼–è¾‘å™¨å®ä¾‹
      let richTextEditor = null;

      function initializeRichTextEditor() {
        // Tiptap ç¼–è¾‘å™¨å·²åœ¨é¡µé¢çš„ module script ä¸­åˆå§‹åŒ–
        console.log('Tiptap å¯Œæ–‡æœ¬ç¼–è¾‘å™¨å°†åœ¨ DOMContentLoaded æ—¶è‡ªåŠ¨åˆå§‹åŒ–');
      }

      function initializeSimpleEditor() {
        // åˆ›å»ºç®€åŒ–çš„å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
        const { createApp } = Vue;
        const richTextApp = createApp({
          data() {
            return {
              htmlContent: '',
              editorElement: null
            }
          },
          mounted() {
            this.initEditor();
          },
          methods: {
            initEditor() {
              // åˆ›å»ºcontenteditable div
              const editorDiv = document.createElement('div');
              editorDiv.contentEditable = true;
              editorDiv.style.cssText = `
                height: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 4px;
                background: #fff;
                outline: none;
                overflow: auto;
                font-family: Arial, sans-serif;
                line-height: 1.5;
              `;

              // å°†ç¼–è¾‘å™¨æ·»åŠ åˆ°Vueåº”ç”¨çš„å®¹å™¨ä¸­
              const container = document.getElementById('simple-editor-container');
              if (container) {
                container.appendChild(editorDiv);
              } else {
                // å¦‚æœå®¹å™¨ä¸å­˜åœ¨ï¼Œåˆ™æ·»åŠ åˆ°rich-text-editor
                document.getElementById('rich-text-editor').appendChild(editorDiv);
              }
              this.editorElement = editorDiv;
            },
            setContent(htmlContent) {
              this.htmlContent = htmlContent;
              if (this.editorElement) {
                this.editorElement.innerHTML = htmlContent;
              }
            },
          },
          template: `
            <div style="height: 100%; display: flex; flex-direction: column;">
              <div style="flex: 1; overflow: auto;" id="simple-editor-container">
              </div>
            </div>
          `
        });

        // æŒ‚è½½ç®€åŒ–ç¼–è¾‘å™¨
        const richTextVm = richTextApp.mount('#rich-text-editor');
        richTextEditor = richTextVm;

        // æš´éœ²åˆ°å…¨å±€
        window.richTextEditor = {
          setContent: (htmlContent) => {
            richTextVm.setContent(htmlContent);
          },
          getContent: () => {
            return richTextVm.htmlContent;
          }
        };
      }

      // å¼€å§‹ç­‰å¾…ObjectVisualizeråŠ è½½
      waitForObjectVisualizer();
    });

  </script>
</body>

</html>